<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Depesche</title>

    <link rel="stylesheet" href="../usr/share/styles/bootstrap.min.css" />
    <link rel="stylesheet" href="../usr/share/openlayers/ol.css" />
    <link rel="stylesheet" href="../usr/share/styles/depesche.css" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>

    <header>
        <div class="container">
            <div class="row">
                <div class="col-xs-6">
                    <p>Freiwillige Feuerwehr Karlstetten</p>
                </div>
                <div class="col-xs-6">
                    <p class="text-right">2016-12-28 11:01:00</p>
                </div>
            </div>
        </div>
    </header>

    <div class="container">

        <div class="row">
            <div class="col-xs-10">
                <h1>Fahrzeugbergung <small>KS0815</small></h1>
            </div>
            <div class="col-xs-2">
                <div class="alert alert-success alarmstufe" role="alert">
                    T2
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-6" id="einsatzort">
                <h3>Einsatzort</h3>
                <table class="table">
                    <tr>
                        <th>Straße</th>
                        <td>{{ Strasse }} {{ Nummer 1 }}</td>
                    </tr>
                    <tr>
                        <th>Ort</th>
                        <td>{{ PLZ }} {{ Ort }}</td>
                    </tr>
                    <tr>
                        <th>Bemerkung</th>
                        <td>{{ Bemerkung }}</td>
                    </tr>
                </table>

                <h3>Melder</h3>
                <table class="table">
                    <tr>
                        <th>Name</th>
                        <td>{{ Melder }}</td>
                    </tr>
                    <tr>
                        <th>Erreichbarkeit</th>
                        <td>{{ MelderTelefon }}</td>
                    </tr>
                </table>
            </div>
            <div class="col-xs-6" id="einsatzdaten">
                <h3>Einsatzdaten</h3>
                <table class="table">
                    <tr>
                        <th>Einsatz-ID</th>
                        <td>{{ EinsatzID }}</td>
                    </tr>
                    <tr>
                        <th>Alarmstufe</th>
                        <td>{{ Alarmstufe }}</td>
                    </tr>
                    <tr>
                        <th>Meldebild</th>
                        <td>{{ Meldebild }}</td>
                    </tr>
                </table>

                <h3>Alarmierte Einheiten</h3>
                <table class="table">
                    <tr>
                        <th>Nr.</th>
                        <th>Name</th>
                        <th>Uhrzeit</th>
                    </tr>
                    <tr>
                        <th>1</th>
                        <td>{{ Einheit 1 }}</td>
                        <td>2016-12-28 00:01:00</td>
                    </tr>
                    <tr>
                        <th>2</th>
                        <td>{{ Einheit 2 }}</td>
                        <td>2016-12-28 00:01:00</td>
                    </tr>
                    <tr>
                        <th>3</th>
                        <td>{{ Einheit 3 }}</td>
                        <td>2016-12-28 00:01:00</td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-12">
                <h3>Detailansicht</h3>
                <div class="map" id="map-detail"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-12">
                <h3>Detailansicht (Orthofoto)</h3>
                <div class="map" id="map-photo"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-12">
                <h3>Übersicht</h3>
                <div class="map" id="map-overview"></div>
            </div>
        </div>

    </div>

    <footer>
        <div class="container">
            <p class="small">Printed on {{ Host }} by </p>
        </div>
    </footer>

    <script src="../usr/share/jquery/jquery-3.1.1.min.js"></script>
    <script src="../usr/share/openlayers/ol.js"></script>
    <script type="text/javascript">


        var latLng = [15.565833, 48.258598];

        // https://www.osmhydrant.org/overpass/fire-water-utilities/15.548999011516573,48.256573154547375,15.578851997852322,48.25986678576577

        var coords = ol.proj.fromLonLat(latLng);

        var capabilitiesUrl = 'http://www.basemap.at/wmts/1.0.0/WMTSCapabilities.xml';

        var hydrantBaseUrl = 'https://www.osmhydrant.org/overpass/fire-water-utilities/';

        // HiDPI support:
        // * Use 'bmaphidpi' layer (pixel ratio 2) for device pixel ratio > 1
        // * Use 'geolandbasemap' layer (pixel ratio 1) for device pixel ratio == 1
        var hiDPI = ol.has.DEVICE_PIXEL_RATIO > 1;
        //var layer = hiDPI ? 'bmaphidpi' : 'geolandbasemap';
        var layer = 'bmaphidpi';
        //var tilePixelRatio = hiDPI ? 2 : 1;
        var tilePixelRatio = 2;

        var mapDetail = new ol.Map({
            target: 'map-detail',
            view: new ol.View({
                center: coords,
                zoom: 19
            }
            ),
            controls: [],
            interactions: []
        });

        var mapPhoto = new ol.Map({
            target: 'map-photo',
            view: new ol.View({
                    center: coords,
                    zoom: 19
                }
            ),
            controls: [],
            interactions: []
        });

        var mapOverview = new ol.Map({
            target: 'map-overview',
            view: new ol.View({
                    center: coords,
                    zoom: 17
                }
            ),
            controls: [],
            interactions: []
        });

        var iconFeatures=[];

        var iconFeature = new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.transform(latLng, 'EPSG:4326',
                'EPSG:3857'))
        });

        iconFeatures.push(iconFeature);

        var vectorSource = new ol.source.Vector({
            features: iconFeatures //add an array of features
        });

        var iconStyle = new ol.style.Style({
            image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                anchor: [0, 0],
                anchorXUnits: 'fraction',
                anchorYUnits: 'pixels',
                opacity: 0.75,
                src: '../usr/share/images/pointer3.png'
            }))
        });


        var vectorLayer = new ol.layer.Vector({
            source: vectorSource,
            style: iconStyle
        });



        $.ajax(capabilitiesUrl).then(function(response) {
            var result = new ol.format.WMTSCapabilities().read(response);

            var optionsMap = ol.source.WMTS.optionsFromCapabilities(result, {
                layer: layer,
                matrixSet: 'google3857',
                requestEncoding: 'REST',
                style: 'normal'
            });

            var optionsPhoto = ol.source.WMTS.optionsFromCapabilities(result, {
                layer: 'bmaporthofoto30cm',
                matrixSet: 'google3857',
                requestEncoding: 'REST',
                style: 'normal'
            });

            var optionsPhotoOverlay = ol.source.WMTS.optionsFromCapabilities(result, {
                layer: 'bmapoverlay',
                matrixSet: 'google3857',
                requestEncoding: 'REST',
                style: 'normal'
            });

            optionsMap.tilePixelRatio = tilePixelRatio;

            mapDetail.addLayer(new ol.layer.Tile({
                source: new ol.source.WMTS(optionsMap)
            }));


            mapDetail.addLayer(vectorLayer);

            mapOverview.addLayer(new ol.layer.Tile({
                source: new ol.source.WMTS(optionsMap)
            }));

            mapOverview.addLayer(vectorLayer);

            mapPhoto.addLayer(new ol.layer.Tile({
                source: new ol.source.WMTS(optionsPhoto)
            }));

            mapPhoto.addLayer(new ol.layer.Tile({
                source: new ol.source.WMTS(optionsPhotoOverlay)
            }));


            mapPhoto.addLayer(vectorLayer);

        });

        var extent = mapOverview.getView().calculateExtent(mapOverview.getSize());
        var upperLeft = ol.proj.toLonLat([extent[0], extent[1]]);
        var lowerRight = ol.proj.toLonLat([extent[2], extent[3]]);
        var hydrantUrl = hydrantBaseUrl + upperLeft[0] + "," + upperLeft[1] + "," + lowerRight[0] + ',' + lowerRight[1];

        $.ajax(hydrantUrl).then(function(response) {
            $.each( response.elements, function( key, value ) {
                console.log( key,value );
            });
        });

    </script>
</body>
</html>
